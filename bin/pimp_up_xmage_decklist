#!/usr/bin/env ruby

require "pathname"
require "memoist"
require "pry"

# If there's multiple potential pimp up versions available, the nicest one is selected.

PimpUpList = [
  ["Aether Vial", "MPS", "6"],
  ["Ajani, Mentor of Heroes", "MED", "RA5"],
  ["Ancient Tomb", "EXP", "36"],
  # ["Ancient Tomb", "PUMA", "U31"],
  ["Arcanum Wings", "FUT", "48"],
  ["Arcbound Ravager", "MPS", "31"],
  ["Arid Mesa", "EXP", "24"],
  ["Aven Mindcensor", "FUT", "18"],
  ["Balefire Dragon", "PUMA", "U14"],
  ["Baru, Fist of Krosa", "FUT", "142"],
  ["Bitter Ordeal", "FUT", "80"],
  ["Bitterblossom", "PUMA", "U7"],
  ["Black Vise", "MPS", "32"],
  ["Blackblade Reforged", "SS2", "8"],
  ["Blade of the Sixth Pride", "FUT", "19"],
  ["Blind Phantasm", "FUT", "49"],
  ["Blood Crypt", "EXP", "8"],
  ["Bloodshot Trainee", "FUT", "110"],
  ["Bloodstained Mire", "EXP", "18"],
  ["Blue Elemental Blast", "SS1", "2"],
  ["Boldwyr Intimidator", "FUT", "111"],
  ["Bonded Fetch", "FUT", "50"],
  ["Bound in Silence", "FUT", "20"],
  ["Brainstorm", "SS1", "3"],
  ["Breeding Pool", "EXP", "15"],
  ["Bridge from Below", "FUT", "81"],
  ["Canopy Vista", "EXP", "5"],
  ["Cascade Bluffs", "EXP", "32"],
  ["Cataclysmic Gearhulk", "MPS", "1"],
  ["Cavern of Souls", "PUMA", "U32"],
  ["Celestial Colonnade", "PUMA", "U33"],
  ["Centaur Omenreader", "FUT", "143"],
  ["Chalice of the Void", "MPS", "33"],
  ["Champion's Helm", "MPS", "7"],
  ["Chromatic Lantern", "MPS", "8"],
  ["Chrome Mox", "MPS", "9"],
  ["Cinder Glade", "EXP", "4"],
  ["Cloudstone Curio", "MPS", "10"],
  ["Combustible Gearhulk", "MPS", "4"],
  ["Counterspell", "SS1", "4"],
  ["Creeping Tar Pit", "PUMA", "U34"],
  ["Crucible of Worlds", "MPS", "11"],
  ["Dack Fayden", "MED", "RA6"],
  ["Daretti, Ingenious Iconoclast", "MED", "GR3"],
  ["Dark Depths", "PUMA", "U35"],
  ["Darksteel Garrison", "FUT", "167"],
  ["Daybreak Coronet", "FUT", "21"],
  ["Death Rattle", "FUT", "82"],
  ["Deepcavern Imp", "FUT", "83"],
  ["Defense Grid", "MPS", "34"],
  ["Demonic Tutor", "PUMA", "U8"],
  ["Domri, Chaos Bringer", "MED", "RA7"],
  ["Dryad Arbor", "FUT", "174"],
  ["Duplicant", "MPS", "35"],
  ["Dust Bowl", "EXP", "37"],
  ["Edge of Autumn", "FUT", "144"],
  ["Elspeth, Knight-Errant", "MED", "GR1"],
  ["Emblem of the Warmind", "FUT", "112"],
  ["Emrakul, the Aeons Torn", "PUMA", "U1"],
  ["Engineered Explosives", "MPS", "36"],
  # ["Engineered Explosives", "PUMA", "U28"],
  ["Ensnaring Bridge", "MPS", "37"],
  ["Eternal Witness", "PUMA", "U16"],
  ["Extraplanar Lens", "MPS", "38"],
  ["Eye of Ugin", "EXP", "38"],
  ["Fetid Heath", "EXP", "31"],
  ["Fire-Lit Thicket", "EXP", "29"],
  ["Fleshwrither", "FUT", "84"],
  ["Flooded Grove", "EXP", "35"],
  ["Flooded Strand", "EXP", "16"],
  ["Flowstone Embrace", "FUT", "113"],
  ["Fomori Nomad", "FUT", "114"],
  ["Forbidden Orchard", "EXP", "39"],
  ["Forest", "UST", "216"],
  ["Frenzy Sliver", "FUT", "85"],
  ["Fulminator Mage", "PUMA", "U26"],
  ["Gaddock Teeg", "PUMA", "U21"],
  ["Garruk, Apex Predator", "MED", "WS5"],
  ["Gauntlet of Power", "MPS", "12"],
  ["Ghostfire", "FUT", "115"],
  ["Gideon Blackblade", "MED", "WS2"],
  ["Gideon Jura", "SS2", "1"],
  ["Gifts Ungiven", "SS1", "5"],
  ["Godless Shrine", "EXP", "11"],
  ["Goldmeadow Lookout", "FUT", "22"],
  ["Goryo's Vengeance", "PUMA", "U9"],
  ["Grave Scrabbler", "FUT", "86"],
  ["Graven Cairns", "EXP", "28"],
  # ["Graven Cairns", "FUT", "175"],
  ["Grindstone", "MPS", "39"],
  ["Grinning Ignus", "FUT", "116"],
  ["Grove of the Burnwillows", "FUT", "176"],
  ["Hallowed Fountain", "EXP", "6"],
  ["Hangarback Walker", "MPS", "13"],
  ["Henchfiend of Ukor", "FUT", "117"],
  ["Homing Sliver", "FUT", "118"],
  ["Horizon Canopy", "EXP", "40"],
  # ["Horizon Canopy", "FUT", "177"],
  ["Imperial Mask", "FUT", "23"],
  ["Imperiosaur", "FUT", "145"],
  ["Island", "UST", "213"],
  ["Jace Beleren", "SS1", "1"],
  ["Jace, the Mind Sculptor", "MED", "WS3"],
  ["Jaya Ballard", "MED", "RA4"],
  ["Karakas", "PUMA", "U36"],
  ["Karn Liberated", "PUMA", "U2"],
  ["Karn, Scion of Urza", "MED", "RA1"],
  ["Kaya, Orzhov Usurper", "MED", "RA8"],
  ["Kitchen Finks", "PUMA", "U27"],
  ["Kor Haven", "EXP", "41"],
  ["Korlash, Heir to Blackblade", "FUT", "87"],
  ["Kozilek, Butcher of Truth", "PUMA", "U3"],
  ["Lavaclaw Reaches", "PUMA", "U37"],
  ["Leovold, Emissary of Trest", "PUMA", "U22"],
  ["Life from the Loam", "PUMA", "U17"],
  ["Lightning Greaves", "MPS", "14"],
  ["Liliana of the Veil", "PUMA", "U10"],
  ["Liliana, the Last Hope", "MED", "GR2"],
  ["Linessa, Zephyr Mage", "FUT", "51"],
  ["Logic Knot", "FUT", "52"],
  ["Lord of Extinction", "PUMA", "U23"],
  ["Lotus Petal", "MPS", "15"],
  ["Lucent Liminid", "FUT", "24"],
  ["Lumithread Field", "FUT", "25"],
  ["Lymph Sliver", "FUT", "26"],
  ["Maelstrom Pulse", "PUMA", "U24"],
  ["Mana Confluence", "EXP", "42"],
  ["Mana Crypt", "MPS", "16"],
  ["Mana Vault", "MPS", "17"],
  # ["Mana Vault", "PUMA", "U29"],
  ["Marsh Flats", "EXP", "21"],
  ["Martyr's Bond", "SS2", "2"],
  ["Mass of Ghouls", "FUT", "88"],
  ["Meekstone", "MPS", "40"],
  ["Mesmeric Sliver", "FUT", "53"],
  ["Mikaeus, the Unhallowed", "PUMA", "U11"],
  ["Mind's Eye", "MPS", "18"],
  ["Mistmeadow Skulk", "FUT", "27"],
  ["Misty Rainforest", "EXP", "25"],
  ["Mountain", "UST", "215"],
  ["Mox Opal", "MPS", "19"],
  ["Muraganda Petroglyphs", "FUT", "146"],
  ["Mystic Gate", "EXP", "26"],
  ["Mystical Tutor", "SS1", "6"],
  ["Nacatl War-Pride", "FUT", "147"],
  ["Nahiri, the Harbinger", "MED", "WS7"],
  ["Narcomoeba", "FUT", "54"],
  ["Negate", "SS1", "7"],
  ["Nessian Courser", "FUT", "148"],
  ["Nicol Bolas, Dragon-God", "MED", "WS6"],
  ["Nicol Bolas, Planeswalker", "MED", "GR4"],
  ["Nimbus Maze", "FUT", "178"],
  ["Nix", "FUT", "55"],
  ["Noble Hierarch", "PUMA", "U18"],
  ["Noxious Gearhulk", "MPS", "3"],
  ["Oblivion Stone", "MPS", "41"],
  ["Oriss, Samite Guardian", "FUT", "28"],
  ["Ornithopter", "MPS", "42"],
  ["Overgrown Tomb", "EXP", "13"],
  ["Painter's Servant", "MPS", "20"],
  ["Paradox Engine", "MPS", "43"],
  ["Path to Exile", "SS2", "3"],
  ["Patrician's Scorn", "FUT", "29"],
  ["Phosphorescent Feast", "FUT", "149"],
  ["Pithing Needle", "MPS", "44"],
  ["Plains", "UST", "212"],
  ["Planar Bridge", "MPS", "45"],
  ["Platinum Angel", "MPS", "46"],
  ["Platinum Emperion", "PUMA", "U30"],
  ["Polluted Delta", "EXP", "17"],
  ["Prairie Stream", "EXP", "1"],
  ["Quagnoth", "FUT", "150"],
  ["Raging Ravine", "PUMA", "U38"],
  ["Ral, Izzet Viceroy", "MED", "GR5"],
  ["Ramosian Revivalist", "FUT", "30"],
  ["Reanimate", "PUMA", "U12"],
  ["Rest in Peace", "SS2", "4"],
  ["Rings of Brighthearth", "MPS", "21"],
  ["River of Tears", "FUT", "179"],
  ["Rugged Prairie", "EXP", "34"],
  ["Sacred Foundry", "EXP", "14"],
  ["Sarcomite Myr", "FUT", "56"],
  ["Sarkhan Unbroken", "MED", "WS8"],
  ["Scalding Tarn", "EXP", "22"],
  ["Scroll Rack", "MPS", "22"],
  ["Sculpting Steel", "MPS", "23"],
  ["Second Wind", "FUT", "57"],
  ["Seht's Tiger", "FUT", "31"],
  ["Shah of Naar Isle", "FUT", "119"],
  ["Shapeshifter's Marrow", "FUT", "58"],
  ["Shielded by Faith", "SS2", "5"],
  ["Sigarda, Host of Herons", "PUMA", "U25"],
  ["Skizzik Surger", "FUT", "120"],
  ["Smoldering Marsh", "EXP", "3"],
  ["Snake Cult Initiation", "FUT", "89"],
  ["Snapcaster Mage", "PUMA", "U5"],
  ["Sol Ring", "MPS", "24"],
  ["Solemn Simulacrum", "MPS", "25"],
  ["Sorin Markov", "MED", "RA3"],
  ["Spellweaver Volute", "FUT", "59"],
  ["Spellwild Ouphe", "FUT", "151"],
  ["Sphere of Resistance", "MPS", "47"],
  ["Spin into Myth", "FUT", "60"],
  ["Sporoloth Ancient", "FUT", "152"],
  ["Staff of Domination", "MPS", "48"],
  ["Static Orb", "MPS", "26"],
  ["Steam Vents", "EXP", "12"],
  ["Steamflogger Boss", "FUT", "121"],
  ["Steel Overseer", "MPS", "27"],
  ["Stirring Wildwood", "PUMA", "U39"],
  ["Stomping Ground", "EXP", "9"],
  ["Storm Entity", "FUT", "122"],
  ["Street Wraith", "FUT", "90"],
  ["Strip Mine", "EXP", "43"],
  ["Sundering Titan", "MPS", "49"],
  ["Sunken Hollow", "EXP", "2"],
  ["Sunken Ruins", "EXP", "27"],
  ["Swamp", "UST", "214"],
  ["Sword of Body and Mind", "MPS", "50"],
  ["Sword of Feast and Famine", "MPS", "28"],
  ["Sword of Fire and Ice", "MPS", "29"],
  ["Sword of Light and Shadow", "MPS", "30"],
  ["Sword of War and Peace", "MPS", "51"],
  ["Tamiyo, the Moon Sage", "MED", "RA2"],
  # ["Tarmogoyf", "FUT", "153"],
  ["Tarmogoyf", "PUMA", "U19"],
  ["Tarox Bladewing", "FUT", "123"],
  ["Tasigur, the Golden Fang", "PUMA", "U13"],
  ["Tectonic Edge", "EXP", "44"],
  ["Teferi, Hero of Dominaria", "MED", "GR6"],
  ["Temple Garden", "EXP", "10"],
  ["Temporal Manipulation", "PUMA", "U6"],
  ["Tezzeret the Seeker", "MED", "WS4"],
  ["Tezzeret, Agent of Bolas", "MED", "GR7"],
  ["Thornweald Archer", "FUT", "154"],
  ["Threads of Disloyalty", "SS1", "8"],
  ["Through the Breach", "PUMA", "U15"],
  ["Thunderblade Charge", "FUT", "124"],
  ["Tombstalker", "FUT", "91"],
  ["Torrential Gearhulk", "MPS", "2"],
  ["Trinisphere", "MPS", "52"],
  ["True Conviction", "SS2", "6"],
  ["Twilight Mire", "EXP", "33"],
  ["Ugin, the Spirit Dragon", "MED", "WS1"],
  ["Ulamog, the Infinite Gyre", "PUMA", "U4"],
  ["Urborg, Tomb of Yawgmoth", "PUMA", "U40"],
  ["Vedalken Aethermage", "FUT", "61"],
  ["Vedalken Shackles", "MPS", "53"],
  ["Vengevine", "PUMA", "U20"],
  ["Verdant Catacombs", "EXP", "23"],
  ["Verdurous Gearhulk", "MPS", "5"],
  ["Virulent Sliver", "FUT", "155"],
  ["Vraska, Golgari Queen", "MED", "GR8"],
  ["Wasteland", "EXP", "45"],
  ["Watery Grave", "EXP", "7"],
  ["Whetwheel", "FUT", "168"],
  ["Whip-Spine Drake", "FUT", "62"],
  ["Windswept Heath", "EXP", "20"],
  ["Witch's Mist", "FUT", "92"],
  ["Wooded Bastion", "EXP", "30"],
  ["Wooded Foothills", "EXP", "19"],
  ["Worship", "SS2", "7"],
  ["Wurmcoil Engine", "MPS", "54"],
  ["Yixlid Jailer", "FUT", "93"],
  ["Zoetic Cavern", "FUT", "180"],
].to_h{|n,s,e| [n, "#{s}:#{e}"] }

class PimpUpXmageDecklist
  extend Memoist

  def initialize(path)
    @path = Pathname(path)
    @decklist = @path.read
  end

  memoize def cards
    @decklist.scan(/^\d+\s+\[(.*?)\]\s*(.*?)\r?$/).map(&:reverse)
  end

  memoize def pimpable_cards
    cards.select{|c,v| PimpUpList[c] and v != PimpUpList[c] }
  end

  def call
    return if pimpable_cards.empty?
    @pimped_up_decklist = @decklist.dup
    pimpable_cards.each do |c,v|
      @pimped_up_decklist.gsub!("[#{v}]", "[#{PimpUpList[c]}]")
    end
    Pathname("#{@path}.bak").write(@decklist)
    @path.write(@pimped_up_decklist)
  end
end

ARGV.each do |path|
  PimpUpXmageDecklist.new(path).call
end
